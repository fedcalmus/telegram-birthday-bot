import datetime
import json
import os
from telegram import Bot, Update, ChatMemberUpdated
from telegram.ext import (
    ApplicationBuilder, ContextTypes, ChatMemberHandler
)
import pytz

TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

# Armenia timezone
ARMENIA_TZ = pytz.timezone("Asia/Yerevan")

# ---- Birthday Database ----
birthdays = {
    "Davit": {
        "date": "11-25",
        "message": "๐ ีีีีีิฑีีี ีีีิด, ิฟีฟึีซี ิดิฑีิปีิน! Python-ีซ ีพีกึีบีฅีฟ, ีีถีฅึีซ ินีกีฃีกีพีธึ, ีีธีถีกีตีซ ีฝึีฟีซ ีฟีซึีกีฏีกีฌ, ีดีฅึ ีฝึีฟีซ ีฏีกีฟีกีฏีฅึีฃีธึ ีธึ ิผีธีฌีซีฏีธีพ ีีพีกีฎีฅีฒีซ ิณีธึีคีธีถ ีีกีดีฆีซึ
                    ิดีธึ ีกีตีถ ีฅีฆีกีฏีซ ยซีดีกึีคโีฐีธึีดีธึีกีตีซีถ ึีขีตีฅีฏีฟีถยป ีฅีฝ, ีธึ ีฏีกึีธีฒีกีถีธึีด ีง ีดีซีกึีถีฅีฌ ีฏีธีคีซีถีฃีจ, ีฉีกีฃีกีพีธึีกีฏีกีถ ีทีถีกีตีซีถ ีญีถีกีดึีถ ีธึ Matthew McConaugheyโีซ ีกีฝีฟีซีณีกีถีซ ีคีฅึีกีฝีกีถีกีฏีกีถ ีญีกีฒีจึ
                    ีีซีนีซีฃีกีถีถ ีธึ ีีซีถีกีถ ีกีบึีธึีด ีฅีถ ีกีตีถีบีซีฝีซ ีทึีฅีฒีธึีฉีตีกีดีข, ีธึ ีดีฅีถึ ีกึีคีฅีถ ีฐีกีดีธีฆีพีกีฎ ีฅีถึี ีทีธึีฟีธีพ ีซึีฅีถึ ึีฅีฆ ยซีฝีซึีฅีฌีซ ีฎีกีผีกยป ีฅีถ ีฏีธีนีฅีฌีธึโีกีดีฅีถีกีฌีกีพ ีฝีถีธึีถีค, ีกีดีฅีถีกีฌีกีพ ีญีถีกีดึ, ีกีดีฅีถ ึึ ีฆีขีธีฝีกีถึโฆ
                    ิดีธึ ีณีฏีธึีถ ีฅีฝ ีดีซีถีนึ 3D ีกีถีซีดีกึีซีกีตีซ ีฝีกีฐีดีกีถ,
                     ีึ ึีธ ีฐีธึีดีธึีจ ีงีถึีกีถ ีคีซีบีธึีฏ ีง, ีธึ Python-ีจ Error ีนีซ ีฟีกีฌีซีฝ ึีฅีฆ ีพึีกี ีฆีธึีฟ ีกีดีกีนีฅีฌีธีพึ
                    ีีกึีฃึีซ ีฐีฅีฟ ีฑีฅึ ีดีกีถีฏีธึีฉีตีกีถ ึีธีฌีกีขีธึีกึีซีกีถ Oscar-ีซ ีกึีชีกีถีซ ีง, ีซีฝีฏ ีีกีนีฅีถ ีธึ ิดีกีพีธีถ ีดีซีทีฟ ีกีตีถีฟีฅีฒี ีฏีฝีบีกีฝีฅีถ ีธึ ีฏีฌึีกึีถีฅีถ ีกีตีถี ีฏีกีฌีตีกีถีกีตีซีถ ึีซีฌีซีฝีธึีกีตีกีฏีกีถ ีถีซีฝีฟีฅึีซ ีถีฅึึีธึ
                    ีีธีถีกีถี ึีธ ีฉีกีฃีธึีฐีซีถ ๐ธ๐
                     ิดีธึ ีถึีกีถ ีกีตีถีบีซีฝีซ ีปีฅึีดีธึีฉีตีกีดีข ีธึ ีฝีซึีธีพ ีฅีฝ ีพีฅึีกีขีฅึีพีธึีด, ีธึ Hollywood-ีซ ีผีธีดีฏีธีดีถีฅึีจ ีฌีกึีธึีด ีฅีถ ีกีถีฏีตีธึีถีธึีด ีธึ ีกีฝีธึีดี ยซีงีฝ ีธีถึ ีก ีกีถีธึีด ีงีฝ ิดีกีพีธีถยปึ
                    ีีกึีธึีถีกีฏีซึ ีญีธึีกีถีกีฌ ีกีทีญีกึีฐีซ ีกีดีฅีถีกีฐีฅีฟีกึึึีซึ ีฉีฅีดีกีถีฅึีซ ีดีฅีปี ีฝีฏีฝีกีฎ ีฟีซีฅีฆีฅึึีซึ ีดีซีถีนึ ีธีถึ ีฐีกีดีธีพ ีฝีกึึีฅีฌ ีฌีธีฌีซีฏีธีพ ีฑีพีกีฎีฅีฒ:
                    ิดีกีพีซีฉ ีปีกีถ, ีฉีธีฒ ีงีฝ ีฟีกึีซีถ ีฌีซ ีฌีซีถีซ ีงีถ ีถีธึีตีถ ีฌีฅีฃีฅีถีคีกึ ีฟึีกีดีกีคึีธึีฉีตีกีดีข, ีซีถีน nonstop ีขีฅึีธึีด ีฅีฝี ีกีผีกีถึ ีฏึีฏีถีพีฅีฌีธึ, ีกีผีกีถึ Error-ีซ, ีกีผีกีถึ Buffer Overflow-ีซึ ิฟีตีกีถึีค ีฌีซีถีซ ีกีตีถึีกีถ ีฏีกีฟีกึีตีกีฌ ีธึึีกีถ ีคีธึ ีฅีฝ ีฟีกีฌีซีฝ ีีซีนีซีฃีกีถีซีถ ีธึ ีีซีถีกีตีซีถ, ีีธีถีกีตีซ ีฐีฅีฟ ีฌีซีถีฅึ ีกีพีฅีฌีซ ีฅึีปีกีถีซีฏ, ีกีณีฅึ, ีขีกีฆีดีกีถีกึ, ีคีฅ ีฌีธีฌีซีฏีธีพ ีฑีพีกีฎีฅีฒีค  ีงีฌ Michelin star-ีซ ีกึีชีกีถีกีถีก โฆ",
        "sticker": "CAACAgQAAx..."
    },
    "Bob": {
        "date": "11-26",
        "message": ๐ธโจ ีีีีีิฑีีี ีีีิด, ีีีิฑี โ PM Queen, ีีกีถีคีกึีฟีธึีฉีตีกีถ ิฑีฝีฟีพีกีฎีธึีฐีซ, ีีกีถ ีีฅีดีธีถีฟีซ ิณีธึึีธึ ึ ิดีกีพีซีฉีซ ีึีฟีซ ิผีฅีฃีฅีถีคีกึ ิฟีกึีฃีกีพีธึีซีน ๐๐
                   ีีธีถีก ีปีกีถ, ีกีตีฝึึ ีบีฅีฟึ ีก ีทีถีธึีฐีกีพีธึีฅีด ีดีซ ีดีกึีคีธึ, ีธีพ PM ีงี ีขีกีตึ ีธีน ีฝีธีพีธึีกีฏีกีถ PMึ ิดีธึ project manager ีฅีฝ ีธีน ีดีซีกีตีถ ีกีทีญีกีฟีกีถึีธึีด, ีกีตีฌึ ีฏีตีกีถึีธึีดึ ิณีธึีฎีธึีด ีคีธึ task-ีฅึีจ ีฅีฝ ีขีกีชีกีถีธึีด, ีฟีกีถีจี ีญีธีฐีกีถีธึีจ, ีฐีตีธึึีกีฝีฅีถีตีกีฏีจ, ีฌีธีฃีกึีกีถีจึ ีีฟีถีธึีด ีฅีฝ ีฟีธึีถ โ ีธึ ีกีฝีฅีฝ Jira-ีถ ีง ีขีกึีพีธึีด ีฃีฌีญีธึีดีคึ
                   ิดีกีพีซีฉีจ ึีฅีฆ ีงีถีบีฅีฝ ีง ีฝีซึีธึีด, ีธึ ีกีทีญีกึีฐีซ ีขีธีฌีธึ ีผีธีดีกีถีฟีซีฏ ึีซีฌีดีฅึีจ ีฏีกีถีฃีถีธึีด ีฅีถ ีกีถีฏีตีธึีถีธึีด ีธึ ีดีฟีกีฎีธึีดี โีดีฅึ ีฝึีฅีถีกึีจ ีซีถีนีซี ีนีซ ีคีซีดีกีถีธึีด ีีธีถีกโิดีกีพีซีฉ ีฐีกึีกีขีฅึีธึีฉีตีธึีถีถีฅึีซีถโึ
                    ีึ ีคีธึ ีงีฌ ีกีถึีฅีฌ ีฅีฝ full-wife mode-ีซ ีขีธีฌีธึ ีดีกีฏีกึีคีกีฏีถีฅึีจี ีกึีคีธึีฏ, ีฐีกึ, ีฏีธีฏีซีฏีธึีฉีตีธึีถ, ีฏีกีฆีดีกีฏีฅึีบีพีกีฎีธึีฉีตีธึีถี ีกีดีฅีถ ีซีถีนีจ checkpoint-ีธีพึ
                   ีีธีถีก ีปีกีถ, ีคีธึ ีฐีกีถีคีกึีฟ ีขีถีกีพีธึีธึีฉีตีธึีถ ีธึีถีฅีฝ โ ีงีถึีกีถ ีฐีกีถีฃีซีฝีฟ ีฅีฝ, ีธึ ีฅีฉีฅ ึีธ ีฏีธีฒึีจ ีฐึีคีฅีฐ ีฌีซีถีซ, ีคีธึ ีคีฅีผ ีฏีฏีกึีธีฒีกีถีกีฝ calmly ีกีฝีฅีฌ.
                    โ ีฟีฒีฅีึึ, ีดีกึีธีฒีจ ีฑีกีญ ัะบะฐัีธึีด ีกึ
                    ีีซีดีก ีงีฌ ีดีซีกึีฅีฌ ีฅีฝ ีทีธึีถีซีฏีถีฅึีซ ีกีทีญีกึีฐีซีถี Michigan-ีซีถ ีธึ Gina-ีซีถึ ีีฅีถึ ีถึีกีีถึ ีถีฏีกีฟีดีกีดีข ีธึีทีกีคึีธึีฉีตีธึีถีถ ีธึ ีณีทีฟีกีบีกีฐีธึีฉีตีธึีถีจ probably ิดีกีพีซีฉีซ character referenceโีถีฅึีถ ีฅีถ ีฅีฒีฅีฌึ ิฟีซีถ ีจีถีฟึีฅีฌีซีฝ ีณีซีทีฟ ีง ีกึีฅีฌี ีทีธึีถ ีฝีซึีธีฒีจ ีพีกีฟ ีดีกึีค ีนีซ ีฌีซีถีซึ
                   ีีกีถีกีบีกึีฐีธึีคีฅีฌ โ oooh yes! ีีฅีฆ suitcase-ีจ ีฟีฅีฝีถีธึีด ีง ีธึ ีซีถึีถ ีง ีฌีซึึีกีพีธึีพีธึีดึ ิดีธึ ึีฟีกึ ีฅึีฏึีธึีด ีถีธึีตีถีซีฝีฏ maps-ีซีถ ีฅีฝ ีกีฝีธึีดี โีกึีซ, ีฅีฝ ีฏีฏีกีฆีดีกีฏีฅึีบีฅีดโึ
                   ีีกีถ ีผีฅีดีธีถีฟีจโฆ ิฑีญ, ีงีค ีดีซ ีกีผีกีถีฑีซีถ ีบีกีฟีดีธึีฉีตีธึีถ ีงึ ิดีธึ ีกึีคีฅีถ ีบึีธึีฅีฝีซีธีถีกีฌ ีฅีฝึ ิณีธึีถีกีตีซีถ ีบีกีฌีซีฟึีกี, ีฌีกีดีบีซ ีคีซึึีกีพีธึีธีึีด, ีบีกีฟีซ textureโีจ, ีคีผีกีถ ีบีฟีธึีฟีกีฏีซ ีฟึีกีดีกีนีกึีจ โ ีีธีถีกีถ ีฃีซีฟีซึ
                    ีีธีฌีธึีพีกีีฎ ีฅีฝ.
                    ีีซีดีกีถีกีฝ ีซีถีน ีฃีซีบีฝีธีฏีกึีฟีธีถ ีจีถีฟึีฅีฌ โ ีีธีถีกีถ ีกึีคีฅีถ ีฅีฆึีกึีกีฏีซีน ีกีผีกีปีกึีฏีถ ีธึีถีซึ
                    ิดีธึ basically ีคีกึีฑีฅีฌ ีฅีฝ Yerevan Home Makeover-ีซ ีฃีฌีญีกีพีธึ ีญีธึีฐึีคีกีฟีธึีถึ
                   ีีซีกีฏ ีขีกีถีจ, ีธึ balance ีนีฅีฝ ีฏีกึีธีฒีกีถีธึีด ีบีกีฐีฅีฌ, ีง ีีกึีฃึโิดีกีพีซีฉ bromance-ีซ ีฐีกีถีคีฅีบ ีญีกีถีคีจึ ๐
                    ิดีธึ ีถีกีตีธึีด ีฅีฝ, ีฉีฅ ีธีถึ ีฅีถ ีซึีกึ ีถีกีตีธึีด, ีฎีซีฎีกีฒีธึีด, ีฏีกีฌีตีกีถ ึีกีทีธึีดี ีธึ ีถีฅึีฝีธึีดีค ีดีซ ึีธึึ โีฐีจีดีดีดโ ีก ีฌีซีถีธึีดึ ิฒีกีตึ ีดีซ ีกีถีฐีกีถีฃีฝีฟีกึีซึ, ีคีธึ Queen-ีจ ีฅีฝ, ีดีถีกึีกีฎีจ side charactersึ
                   ีีธีถีก ีปีกีถ, ีฉีธีฒ ึีธ ีฟีกึีซีถ ีฌีซีถีซ ีฐีกีถีคีกึีฟ, ีฏีกีฆีดีกีฏีฅึีบีพีกีฎ, ีฝีซึีธีพ ีฌีซ ีธึ ีงีถีบีฅีฝ ีปีฅึีด, ีซีถีนีบีซีฝีซีถ ีคีธึ ีฅีฝึ ินีธีฒ ิดีกีพีซีฉีจ ึีฅีฆ ีบีฅีฝ attentive ีดีถีก, ีทีธึีถีซีฏีถีฅึีจ ึีฅีฆ ีพึีก ีญีฅีถีฉีกีถีกีถ, ีซีฝีฏ ีฟีธึีถีจ ีดีซีทีฟ ีฌีซีถีซ ีกีตีถีบีฅีฝ ีฐีกีพีกึ, ีธึ Pinterest-ีจ ีฆีกีถีฃีซี โcan we feature your home?",
        "sticker": "CAACAgIAAx..."
    }
}

GROUPS_FILE = "groups.json"


# ------------------ GROUP STORAGE ------------------
def load_groups():
    try:
        with open(GROUPS_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return []


def save_groups(groups):
    with open(GROUPS_FILE, "w") as f:
        json.dump(groups, f)


# ---------------- BOT ADDED TO GROUP ----------------
async def bot_added(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.my_chat_member:
        new_status = update.my_chat_member.new_chat_member.status
        chat_id = update.my_chat_member.chat.id

        # Bot added to a group
        if new_status in ["member", "administrator"]:
            groups = load_groups()
            if chat_id not in groups:
                groups.append(chat_id)
                save_groups(groups)
                await context.bot.send_message(chat_id, "๐ Hello MM members! Starting from now Iโll send birthday messages here! Take a breath, relax and enjoy it. :D")
        # Bot removed
        elif new_status == "left":
            groups = load_groups()
            if chat_id in groups:
                groups.remove(chat_id)
                save_groups(groups)


# ------------------ BIRTHDAY CHECK -----------------
async def check_birthdays(context: ContextTypes.DEFAULT_TYPE):
    today = datetime.datetime.now(ARMENIA_TZ).strftime("%m-%d")
    groups = load_groups()

    for name, data in birthdays.items():
        if data["date"] == today:
            for group_id in groups:
                await context.bot.send_message(group_id, f"{data['message']} ๐")
                await context.bot.send_sticker(group_id, data["sticker"])


# ------------------ MAIN ---------------------------
def main():
    app = ApplicationBuilder().token(TOKEN).build()

    # Detect when bot is added / removed
    app.add_handler(ChatMemberHandler(bot_added, ChatMemberHandler.MY_CHAT_MEMBER))

    # Schedule daily birthday check at 8:00 AM Armenia time
    job_queue = app.job_queue
    if job_queue:
        time_obj = datetime.time(hour=11, minute=11, tzinfo=ARMENIA_TZ)
        job_queue.run_daily(check_birthdays, time=time_obj)

    app.run_polling()


if __name__ == "__main__":
    main()
